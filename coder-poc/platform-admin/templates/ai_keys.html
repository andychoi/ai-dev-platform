<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Keys - Platform Admin</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; color: #333; }
        header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px 30px; }
        header h1 { font-size: 1.8em; font-weight: 600; }
        header nav { display: flex; gap: 15px; }
        header nav a { color: rgba(255,255,255,0.85); text-decoration: none; padding: 5px 10px; border-radius: 4px; font-size: 0.9em; }
        header nav a:hover { background: rgba(255,255,255,0.15); }
        header nav a.active { background: rgba(255,255,255,0.2); color: white; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px 30px; }
        .cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .card { background: white; border-radius: 10px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); text-align: center; }
        .card-value { font-size: 2em; font-weight: 700; color: #667eea; }
        .card-label { color: #666; font-size: 0.85em; margin-top: 5px; }
        .table-section { background: white; border-radius: 10px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .table-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .table-header h2 { font-size: 1.1em; font-weight: 600; }
        table { width: 100%; border-collapse: collapse; font-size: 0.85em; }
        th { text-align: left; padding: 8px 10px; border-bottom: 2px solid #e0e0e0; color: #666; font-weight: 600; font-size: 0.85em; text-transform: uppercase; }
        td { padding: 8px 10px; border-bottom: 1px solid #f0f0f0; }
        tr:hover { background: #f8f9ff; }
        code { background: #f0f0f0; padding: 2px 6px; border-radius: 3px; font-size: 0.9em; font-family: 'SF Mono', SFMono-Regular, Consolas, monospace; }
        .badge { display: inline-block; padding: 2px 8px; border-radius: 12px; font-size: 0.75em; font-weight: 600; }
        .badge-blue { background: #e8f0fe; color: #1a73e8; }
        .badge-green { background: #e6f4ea; color: #137333; }
        .badge-yellow { background: #fef7e0; color: #b06000; }
        .badge-red { background: #fce8e6; color: #c5221f; }
        .badge-gray { background: #f0f0f0; color: #666; }
        .spend-bar { display: inline-block; width: 80px; height: 6px; background: #e0e0e0; border-radius: 3px; vertical-align: middle; margin-left: 5px; }
        .spend-fill { height: 100%; border-radius: 3px; background: #667eea; }
        .spend-fill.warn { background: #f9a825; }
        .spend-fill.danger { background: #c5221f; }
        .key-full { display: none; }
        .key-toggle { cursor: pointer; color: #667eea; font-size: 0.8em; margin-left: 5px; }
        .key-toggle:hover { text-decoration: underline; }
        .btn { padding: 6px 14px; border: none; border-radius: 5px; cursor: pointer; font-size: 0.85em; font-weight: 500; }
        .btn-primary { background: #667eea; color: white; }
        .btn-primary:hover { background: #5a6fd6; }
        .btn-danger { background: #c5221f; color: white; font-size: 0.75em; padding: 3px 8px; }
        .btn-danger:hover { background: #a31b18; }
        .error { background: #fce8e6; color: #c5221f; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .new-key-result { background: #e6f4ea; border: 1px solid #137333; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .new-key-result code { background: #d4edda; font-size: 1em; padding: 4px 8px; word-break: break-all; }
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.4); z-index: 100; }
        .modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%,-50%); background: white; border-radius: 12px; padding: 25px; min-width: 400px; z-index: 101; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
        .modal h3 { margin-bottom: 15px; }
        .modal input, .modal select { width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 5px; }
        .modal-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 15px; }
    </style>
</head>
<body>
    <header>
        <div style="display: flex; align-items: center; gap: 20px;">
            <h1>Platform Admin</h1>
            <nav>
                <a href="{{ url_for('dashboard') }}">Databases</a>
                <a href="{{ url_for('services') }}">Services</a>
                <a href="{{ url_for('ai_usage') }}">AI Usage</a>
                <a href="{{ url_for('ai_keys') }}" class="active">AI Keys</a>
                <a href="{{ url_for('users') }}">Users</a>
                <a href="{{ url_for('workspaces') }}">Workspaces</a>
            </nav>
        </div>
        <div style="margin-top: 5px; display: flex; align-items: center; gap: 15px;">
            {% if current_user %}
            <span style="font-size: 0.9em; opacity: 0.8;">{{ current_user.username }}</span>
            <a href="{{ url_for('logout') }}" style="color: white; text-decoration: none; padding: 5px 12px; background: rgba(255,255,255,0.2); border-radius: 4px; font-size: 0.85em;">Logout</a>
            {% endif %}
        </div>
    </header>

    <div class="container">
        {% if error %}
        <div class="error">Failed to load keys: {{ error }}</div>
        {% endif %}

        <div id="newKeyResult" class="new-key-result" style="display:none;">
            <strong>New key created!</strong> Copy it now — it won't be shown again:<br>
            <div style="display: flex; align-items: center; gap: 8px; margin-top: 8px;">
                <code id="newKeyValue" style="flex: 1; user-select: all;"></code>
                <button class="btn btn-primary" onclick="copyKey()" id="copyBtn" style="white-space: nowrap;">Copy</button>
            </div>
            <div style="margin-top: 6px;">
                <span style="font-size:0.85em; color:#666;">Alias: <span id="newKeyAlias"></span></span>
                <span id="copyStatus" style="font-size:0.85em; color:#137333; margin-left:10px; display:none;">Copied!</span>
            </div>
        </div>

        <!-- Summary Cards -->
        {% set total_keys = keys|length %}
        {% set total_spend = keys|map(attribute='spend')|select('number')|list|sum %}
        {% set total_budget = keys|selectattr('max_budget')|map(attribute='max_budget')|select('number')|list|sum %}
        {% set active_keys = keys|selectattr('key_alias')|list|length %}
        <div class="cards">
            <div class="card">
                <div class="card-value">{{ total_keys }}</div>
                <div class="card-label">Total Keys</div>
            </div>
            <div class="card">
                <div class="card-value">{{ active_keys }}</div>
                <div class="card-label">Named Keys</div>
            </div>
            <div class="card">
                <div class="card-value">${{ "%.2f"|format(total_spend) }}</div>
                <div class="card-label">Total Spend</div>
            </div>
            <div class="card">
                <div class="card-value">${{ "%.0f"|format(total_budget) }}</div>
                <div class="card-label">Total Budget</div>
            </div>
        </div>

        <!-- Keys Table -->
        <div class="table-section">
            <div class="table-header">
                <h2>{% if is_admin %}All Virtual API Keys{% else %}My API Keys{% endif %}</h2>
                <button class="btn btn-primary" onclick="showGenerateModal()">+ Generate Key</button>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Alias</th>
                        <th>Key</th>
                        <th>Scope</th>
                        <th>Spend / Budget</th>
                        <th>Rate Limits</th>
                        <th>Created</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for key in keys %}
                    {% set pct = ((key.spend or 0) / key.max_budget * 100) if key.max_budget else 0 %}
                    <tr>
                        <td>
                            {% if key.key_alias %}
                            <strong>{{ key.key_alias }}</strong>
                            {% else %}
                            <span style="color: #999;">—</span>
                            {% endif %}
                        </td>
                        <td>
                            <code id="key-masked-{{ loop.index }}">{{ key.key_name or key.token[:8] ~ '...' }}</code>
                            <code id="key-full-{{ loop.index }}" class="key-full">{{ key.token }}</code>
                            <span class="key-toggle" onclick="toggleKey({{ loop.index }})">show</span>
                        </td>
                        <td>
                            {% set scope = key.metadata.get('scope', '') if key.metadata else '' %}
                            {% if 'workspace' in scope %}
                            <span class="badge badge-blue">workspace</span>
                            {% elif 'ci:' in scope %}
                            <span class="badge badge-yellow">CI</span>
                            {% elif 'user:' in scope %}
                            <span class="badge badge-green">user</span>
                            {% elif scope %}
                            <span class="badge badge-gray">{{ scope[:20] }}</span>
                            {% else %}
                            <span class="badge badge-gray">unknown</span>
                            {% endif %}
                        </td>
                        <td>
                            ${{ "%.4f"|format(key.spend or 0) }} / ${{ "%.0f"|format(key.max_budget or 0) }}
                            <div class="spend-bar">
                                <div class="spend-fill {{ 'danger' if pct > 80 else 'warn' if pct > 50 else '' }}" style="width: {{ [pct, 100]|min }}%"></div>
                            </div>
                        </td>
                        <td style="font-size: 0.8em; color: #666;">
                            {% if key.rpm_limit %}{{ key.rpm_limit }} rpm{% endif %}
                            {% if key.tpm_limit %}/ {{ (key.tpm_limit / 1000)|int }}k tpm{% endif %}
                            {% if not key.rpm_limit and not key.tpm_limit %}—{% endif %}
                        </td>
                        <td style="font-size: 0.8em; color: #666;">
                            {% if key.created_at %}
                            {{ key.created_at.strftime('%Y-%m-%d') if key.created_at else '—' }}
                            {% else %}—{% endif %}
                        </td>
                        <td>
                            <button class="btn btn-danger" onclick="revokeKey('{{ key.token }}', '{{ key.key_alias or key.key_name }}')">Revoke</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Generate Key Modal -->
    <div id="modalOverlay" class="modal-overlay" onclick="hideGenerateModal()"></div>
    <div id="generateModal" class="modal" style="display:none;">
        <h3>Generate New API Key</h3>
        <label style="font-size:0.85em; color:#666;">Alias (username or identifier)</label>
        <input type="text" id="keyAlias" placeholder="e.g. contractor1">
        <label style="font-size:0.85em; color:#666;">Scope</label>
        <select id="keyScope">
            <option value="user">User (personal key)</option>
            <option value="workspace">Workspace</option>
            <option value="ci">CI Pipeline</option>
        </select>
        <div class="modal-actions">
            <button class="btn" style="background:#e0e0e0;" onclick="hideGenerateModal()">Cancel</button>
            <button class="btn btn-primary" onclick="generateKey()">Generate</button>
        </div>
    </div>

    <script>
    function copyKey() {
        const key = document.getElementById('newKeyValue').textContent;
        navigator.clipboard.writeText(key).then(() => {
            document.getElementById('copyStatus').style.display = 'inline';
            document.getElementById('copyBtn').textContent = 'Copied';
            setTimeout(() => { document.getElementById('copyStatus').style.display = 'none'; }, 3000);
        }).catch(() => {
            // Fallback for non-secure contexts
            const ta = document.createElement('textarea');
            ta.value = key;
            ta.style.position = 'fixed';
            ta.style.opacity = '0';
            document.body.appendChild(ta);
            ta.select();
            document.execCommand('copy');
            document.body.removeChild(ta);
            document.getElementById('copyStatus').style.display = 'inline';
            document.getElementById('copyBtn').textContent = 'Copied';
        });
    }

    function toggleKey(idx) {
        const masked = document.getElementById('key-masked-' + idx);
        const full = document.getElementById('key-full-' + idx);
        const toggle = masked.nextElementSibling.nextElementSibling;
        if (full.style.display === 'none' || !full.style.display) {
            full.style.display = 'inline';
            masked.style.display = 'none';
            toggle.textContent = 'hide';
        } else {
            full.style.display = 'none';
            masked.style.display = 'inline';
            toggle.textContent = 'show';
        }
    }

    function showGenerateModal() {
        document.getElementById('modalOverlay').style.display = 'block';
        document.getElementById('generateModal').style.display = 'block';
    }
    function hideGenerateModal() {
        document.getElementById('modalOverlay').style.display = 'none';
        document.getElementById('generateModal').style.display = 'none';
    }

    async function generateKey() {
        const alias = document.getElementById('keyAlias').value.trim();
        const scope = document.getElementById('keyScope').value;
        if (!alias) { alert('Alias is required'); return; }
        hideGenerateModal();
        try {
            const resp = await fetch('/api/ai-keys/generate', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({alias, scope})
            });
            const data = await resp.json();
            if (data.success && data.key) {
                document.getElementById('newKeyValue').textContent = data.key;
                document.getElementById('newKeyAlias').textContent = data.alias || alias;
                document.getElementById('newKeyResult').style.display = 'block';
                window.scrollTo({top: 0, behavior: 'smooth'});
            } else {
                alert('Failed: ' + (data.error || 'Unknown error'));
            }
        } catch(e) { alert('Error: ' + e.message); }
    }

    async function revokeKey(token, name) {
        if (!confirm('Revoke key "' + name + '"? This cannot be undone.')) return;
        try {
            const resp = await fetch('/api/ai-keys/revoke', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({token})
            });
            const data = await resp.json();
            if (data.success) { location.reload(); }
            else { alert('Failed: ' + (data.error || 'Unknown error')); }
        } catch(e) { alert('Error: ' + e.message); }
    }
    </script>
</body>
</html>
